@page "/game/{GameId:int}"

@using System.Net.Http
@using Football.Core.Models
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.Extensions.Logging
@using Scoreboard.Client.Shared.Components
@using Scoreboard.Client.ViewModels

@inject Config.AppSettings AppSettings
@inject HttpClient Http
@inject ILoggerProvider LoggerProvider
@inject ILogger<GameCast> Logger
@inject NavigationManager NavigationManager

<div class="mdc-layout-grid__inner">
    <!-- Title row -->
    <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-4"></div>
    <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-4">
        Game Page @GameId
    </div>
    <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-4"></div>
    <!-- Game Card row -->
    <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-4"></div>
    <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-4">
        @if (gameState is null && !errorOcurred)
        {
            <div>Loading</div>
        }
        else if (gameState is null && errorOcurred)
        {
            <div>An error ocurred loading the game</div>
        }
        else if (gameState is not null)
        {
            <GameCard GameId="@gameState.Id" AwayTeam="@gameState.AwayTeam" AwayScore=@gameState.AwayScore
            HomeTeam="@gameState.HomeTeam" HomeScore=@gameState.HomeScore
            QuarterTimeRemaining="@gameState.QuarterTimeRemaining" />
        }
    </div>
    <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-4"></div>
</div>

@code {
    private bool errorOcurred = false;

    private HubConnection? hubConnection;

    private GameState? gameState = null;

    private Stat? homeStat = new Stat();

    private Stat? awayStat = new Stat();

    [Parameter]
    public int GameId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var game = await Http.GetFromJsonAsync<Game>($"https://localhost:11517/api/football/games/{GameId}");

            if (game is not null)
            {
                gameState = new GameState
                {
                    Id = game.Id,
                    Week = game.Week,
                    Quarter = 1,
                    QuarterSecondsRemaining = 900,
                    HomeTeam = game.HomeTeam,
                    HomeScore = 0,
                    AwayTeam = game.AwayTeam,
                    AwayScore = 0
                };
            }

            @* var gameStats = await Http.GetFromJsonAsync<Stat[]>($"https://localhost:11517/api/football/stats/{GameId}");
                if (gameStats is not null && gameStats.Count() > 0)
                {
                homeStat = gameStats.FirstOrDefault(g => g.Team == game.HomeTeam);
                awayStat = gameStats.FirstOrDefault(g => g.Team == game.AwayTeam);

                Uri hubUri = new Uri(AppSettings.HubEndpoint);

                hubConnection = new HubConnectionBuilder().WithUrl(hubUri).ConfigureLogging(logging =>
                logging.AddProvider(LoggerProvider)).Build();

                hubConnection.On<Play>("ReceivePlay", (play) =>
                {
                if (GameId == play.Game.Id)
                {
                gameState = new GameState
                {
                HomeTeam = homeStat.Team,
                HomeScore = play.HomeScore,
                AwayTeam = awayStat.Team,
                AwayScore = play.AwayScore,
                Quarter = play.Quarter,
                QuarterSecondsRemaining = play.QuarterSecondsRemaining,
                Description = play.Description
                };
                };

                StateHasChanged();
                });

                await hubConnection.StartAsync();
                }
                else
                {
                startedGame = false;
                } *@
        }
        catch (Exception ex)
        {
            errorOcurred = true;
            logger.LogError(ex.ToString());
        }
    }
}
